#!/usr/bin/env bash

# shellcheck disable=SC2034
SCRIPTPATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 || exit 1 ; pwd -P )"
SCRIPTNAME="$(basename "$0")"

init_logger(){
  local log_file="${XDG_CACHE_HOME:-${HOME}/.cache}/snippets/_log.sh"
  local last_download_file="/tmp/_log.time"
  local delai=14400             # 4 hours
  # shellcheck disable=SC2155
  local curr_time=$(date +%s)
  local time="$(( curr_time - $(cat "${last_download_file}" 2>/dev/null || echo "0") ))"

  if ! [[ -f "${log_file}" ]] \
    || { [[ -f "${log_file}" ]] && [[ "${time}" -gt "${delai}" ]]; }
  then
    if ping -q -c 1 framagit.org &> /dev/null
    then
      # shellcheck disable=SC1090
      source <(curl -s https://framagit.org/-/snippets/7183/raw/main/_get_log.sh)
      echo "${curr_time}" > "${last_download_file}"
    else
      echo -e "\033[1;33m[WARNING]\033[0;33m Unable to get last logger version, will use \`echo\`.\033[0m"
      _log(){
        echo "$@"
      }
    fi
  else
    # shellcheck disable=SC1090
    source <(cat "${log_file}")
  fi
}

_back_file(){
  local file=$1
  _log "INFO" "Backup current file **${file/${HOME}/'~'}**."
  mv "${file}" "${file}.bak"
}

_set_envrc_local(){
  local tpl_file="${src_dir}/envrc.local.template"
  local curr_file="${pwd}/.envrc.local"
  local cfg_file="${conf_path}/envrc.local"
  local rel_curr_file="${curr_file/${HOME}/'~'}"
  local rel_tpl_file="${tpl_file/${HOME}/'~'}"
  local rel_cfg_file="${cfg_file/${HOME}/'~'}"

  if [[ -e "${curr_file}" ]] && ! [[ -L "${curr_file}" ]]
  then
    _log "INFO" "File **${rel_curr_file}** already exists and is not a symlink."
    _backup_file "${curr_file}"
  elif [[ -e "${curr_file}" ]] && ! [[ "${curr_file}" -ef "${cfg_file}" ]]
  then
    _log "INFO" "File **${rel_curr_file}** do no point to right location."
    _backup_file "${curr_file}"
  elif [[ -e "${curr_file}" ]] &&  [[ "${curr_file}" -ef "${cfg_file}" ]]
  then
    _log "INFO" "File **${curr_file/${HOME}/'~'}** already a symlink to **${cfg_file/${HOME}/'~'}**"
    return 0
  fi

  if ! [[ -L "${curr_file}" ]]
  then
    _log "INFO" "Setup file in **${cfg_file}**."
    mkdir -p "$(dirname "${cfg_file}")"
    cp "${tpl_file}" "${cfg_file}"
    chmod 600 "${cfg_file}"
    _log "INFO" "Setup symlinks to **${conf_path/${HOME}/~}/envrc.local**."
    ln -s "${cfg_file}" "${curr_file}"
  fi
}

main(){
  # """Main method which setup direnv config file and symlinks in current directory
  # """
  local DEBUG_LEVEL="${DEBUG_LEVEL:-INFO}"
  init_logger

  # shellcheck disable=SC2155
  local pwd=$(pwd -P)
  local conf_path="${XDG_DATA_DIR:-${HOME}/.local/share}/direnv${pwd/${HOME}/}"
  local src_dir="${HOME}/.config/direnv/templates"

  _set_envrc_local
}

main "$@"

# vim: ft=sh
